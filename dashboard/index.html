<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Wrestling.Systems</title>

    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://assets.wrestling.systems/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://assets.wrestling.systems/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://assets.wrestling.systems/favicon-16x16.png">
    <link rel="shortcut icon" href="https://assets.wrestling.systems/favicon.ico">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .bg-gold-500 { background-color: #D4AF37; }
        .hover\:bg-gold-600:hover { background-color: #C09B2D; }
        .text-gold-300 { color: #E6C75E; }
        .focus\:ring-gold-500:focus { --tw-ring-color: #D4AF37; }
        #loader {
            border: 5px solid #4b5563;
            border-top: 5px solid #D4AF37;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-black text-gray-200 antialiased">
    
    <!-- User Status Display -->
    <div id="user-status" class="absolute top-4 right-4 text-right hidden group z-10">
        <!-- User info will be dynamically populated -->
    </div>

    <!-- Main Container -->
    <div class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-b from-black to-gray-900 p-4">

        <div class="w-full max-w-lg mx-auto text-center pt-12">
            <a href="https://dev.wrestling.systems"><img src="https://assets.wrestling.systems/logo-gemini2.png" alt="Wrestling.Systems Logo" class="w-48 mx-auto mb-6"></a>
        </div>

        <div id="app-container" class="w-full max-w-lg mx-auto bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-2xl p-6 sm:p-8 border border-gray-700 mt-8">
            
            <div id="loader-container" class="flex flex-col items-center justify-center min-h-[300px]">
                <div id="loader"></div>
                <p class="mt-4 text-gold-300">Loading Dashboard...</p>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboard-content" class="hidden">
                <h1 class="text-3xl sm:text-4xl font-bold text-white text-center mb-6">Athlete Dashboard</h1>
                
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-gold-300 mb-3">Your Athletes</h2>
                    <div id="athlete-list" class="space-y-3">
                        <p id="no-athletes-msg" class="text-gray-400 text-center py-4 bg-black/20 rounded-md">No athletes found. Add one below to get started!</p>
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-semibold text-gold-300 mb-3">Add a New Athlete</h2>
                    <div id="add-athlete-form" class="p-4 bg-black/30 rounded-lg">
                        <label for="athlete-name-input" class="block text-sm font-medium text-gray-300 mb-2">Athlete's First Name</label>
                        <div class="flex gap-3">
                            <input type="text" id="athlete-name-input" placeholder="e.g., Jimmy" class="flex-grow bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-gold-500 focus:border-gold-500">
                            <button id="save-athlete-btn" class="bg-gold-500 hover:bg-gold-600 text-white font-bold py-2 px-4 rounded-md">Save</button>
                        </div>
                         <p id="add-athlete-error" class="text-red-400 text-sm mt-2 text-center h-5"></p>
                    </div>
                </div>
                 <a href="https://dev.wrestling.systems/repdown" class="block w-full text-center mt-8 py-3 px-4 border border-transparent rounded-md shadow-sm font-medium text-black bg-gray-300 hover:bg-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gold-500 focus:ring-offset-gray-900 transition-all duration-300">
                    Go to Rep Down Challenge
                </a>
            </div>
        </div>

        <footer class="text-center text-gray-500 mt-12 pb-8">
             <p class="text-sm">&copy; 2025 Wrestling.Systems. All Rights Reserved.</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp, setDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM Elements
        const loaderContainer = document.getElementById('loader-container');
        const dashboardContent = document.getElementById('dashboard-content');
        const userStatusDiv = document.getElementById('user-status');
        const athleteListDiv = document.getElementById('athlete-list');
        const noAthletesMsg = document.getElementById('no-athletes-msg');
        const athleteNameInput = document.getElementById('athlete-name-input');
        const saveAthleteBtn = document.getElementById('save-athlete-btn');
        const addAthleteError = document.getElementById('add-athlete-error');

        // Firebase State
        let auth, db, userId;

        const firebaseConfig = {
            apiKey: "AIzaSyASn9xe5RRKFGXNi-Vha-NunDYj1mv7D3g",
            authDomain: "auth.wrestling.systems",
            projectId: "wrestlingsystems",
            storageBucket: "wrestlingsystems.appspot.com",
            messagingSenderId: "255692661115",
            appId: "1:255692661115:web:7ad4f8d39b78fb1220ddde",
            measurementId: "G-E52GDENT1E"
        };
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                await populateUserInfo(user);
                await fetchAndDisplayAthletes();
                loaderContainer.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
            } else {
                window.location.href = 'https://dev.wrestling.systems/login';
            }
        });

        async function populateUserInfo(user) {
            const userRef = doc(db, "users", user.uid);
            let userName = user.email;
            try {
                const docSnap = await getDoc(userRef);
                if (docSnap.exists() && docSnap.data().firstName) {
                    userName = `Hello, ${docSnap.data().firstName}`;
                }
            } catch (error) { console.error("Error fetching user data:", error); }

            userStatusDiv.innerHTML = `
                <div class="cursor-pointer">
                    <p id="user-display-name" class="font-semibold text-white">${userName}</p>
                </div>
                <div class="absolute top-full right-0 mt-1 w-max bg-gray-800 rounded-md shadow-lg border border-gray-700 hidden group-hover:block transition-all text-left p-3 z-20">
                    <button id="signout-btn" class="w-full text-left text-red-400 font-semibold hover:text-red-300">Sign Out</button>
                </div>`;
            userStatusDiv.classList.remove('hidden');
            document.getElementById('signout-btn').addEventListener('click', () => signOut(auth));
        }

        async function fetchAndDisplayAthletes() {
            const userRef = doc(db, "users", userId);
            const userSnap = await getDoc(userRef);
            if (!userSnap.exists() || !userSnap.data().managedAthletes || userSnap.data().managedAthletes.length === 0) {
                athleteListDiv.innerHTML = '';
                athleteListDiv.appendChild(noAthletesMsg);
                noAthletesMsg.classList.remove('hidden');
                return;
            }
            
            noAthletesMsg.classList.add('hidden');
            athleteListDiv.innerHTML = ''; // Clear previous list
            const athleteIds = userSnap.data().managedAthletes;

            for (const athleteId of athleteIds) {
                const athleteRef = doc(db, "athletes", athleteId);
                const athleteSnap = await getDoc(athleteRef);
                if (athleteSnap.exists()) {
                    const athleteData = athleteSnap.data();
                    const athleteEl = document.createElement('div');
                    athleteEl.className = 'bg-gray-700/50 p-3 rounded-md flex items-center justify-between';
                    athleteEl.innerHTML = `<p class="font-medium text-gray-200">${athleteData.firstName}</p>`;
                    athleteListDiv.appendChild(athleteEl);
                }
            }
        }

        saveAthleteBtn.addEventListener('click', async () => {
            const name = athleteNameInput.value.trim();
            if (!name) {
                addAthleteError.textContent = "Please enter a name.";
                addAthleteError.classList.remove('hidden');
                return;
            }
            addAthleteError.classList.add('hidden');
            saveAthleteBtn.disabled = true;
            saveAthleteBtn.textContent = 'Saving...';

            try {
                // 1. Create the new athlete document
                const newAthleteRef = await addDoc(collection(db, "athletes"), {
                    firstName: name,
                    parentId: userId,
                    createdAt: serverTimestamp(),
                    associatedAuthId: null
                });

                // 2. Add the athlete's ID to the parent's (user) document
                const userRef = doc(db, "users", userId);
                // ** THE FIX IS HERE: Use setDoc with merge to create or update the user doc **
                await setDoc(userRef, {
                    managedAthletes: arrayUnion(newAthleteRef.id)
                }, { merge: true });
                
                athleteNameInput.value = '';
                await fetchAndDisplayAthletes();

            } catch (error) {
                console.error("Error adding athlete:", error);
                addAthleteError.textContent = "Could not save athlete. Please try again.";
                addAthleteError.classList.remove('hidden');
            } finally {
                saveAthleteBtn.disabled = false;
                saveAthleteBtn.textContent = 'Save';
            }
        });
    </script>
</body>
</html>

