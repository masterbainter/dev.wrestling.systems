<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dashboard - Wrestling.Systems (v2.1)</title>

    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://assets.wrestling.systems/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://assets.wrestling.systems/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://assets.wrestling.systems/favicon-16x16.png">
    <link rel="shortcut icon" href="https://assets.wrestling.systems/favicon.ico">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom Gold Color */
        .bg-gold-500 { background-color: #D4AF37; }
        .hover\:bg-gold-600:hover { background-color: #C09B2D; }
        .text-gold-300 { color: #E6C75E; }
        .border-gold-500 { border-color: #D4AF37; }
        .focus\:ring-gold-500:focus { --tw-ring-color: #D4AF37; }
        .focus\:border-gold-500:focus { border-color: #D4AF37; }
        
        #loader {
            border: 5px solid #4b5563;
            border-top: 5px solid #D4AF37;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-black text-gray-200 antialiased">
    
    <!-- User Status Display -->
    <div id="user-status" class="absolute top-4 right-4 text-right hidden group z-10">
        <div class="cursor-pointer">
            <p class="text-gray-400 text-sm">Signed in as</p>
            <p id="user-display-name" class="font-semibold text-white"></p>
        </div>
        <div class="absolute top-full right-0 mt-1 w-max bg-gray-800 rounded-md shadow-lg border border-gray-700 hidden group-hover:block transition-all text-left p-3 z-20">
            <div id="provider-icon-container" class="w-4 h-4 inline-block mr-2"></div>
            <p id="user-email-display" class="text-sm text-gray-300 mb-2"></p>
            <button id="signout-btn" class="bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1 rounded transition-colors">
                Sign Out
            </button>
        </div>
    </div>

    <!-- Email Verification Banner -->
    <div id="email-verification-banner" class="bg-yellow-900/30 border-b border-yellow-500/30 p-3 text-center hidden">
        <div class="max-w-4xl mx-auto">
            <p class="text-yellow-300 text-sm">
                üìß Please verify your email address to use all features. 
                <button id="resend-verification-btn" class="underline hover:no-underline ml-2">Resend Email</button>
            </p>
        </div>
    </div>

    <!-- Development Beta Warning Banner -->
    <div class="bg-amber-900/30 border-b border-amber-500/30 p-3 text-center">
        <div class="max-w-4xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-3">
            <div class="text-left">
                <p class="text-amber-300 text-sm font-medium">‚ö†Ô∏è Development Beta - All data is temporary</p>
                <p class="text-amber-200 text-xs">Data will be deleted when official site launches</p>
            </div>
            <button id="request-migration-btn" class="bg-amber-600 hover:bg-amber-700 text-white text-xs px-3 py-2 rounded transition-colors whitespace-nowrap">
                Request Data Migration
            </button>
        </div>
    </div>

    <!-- Duplicate Account Detection Banner -->
    <div id="duplicate-account-banner" class="bg-blue-900/30 border-b border-blue-500/30 p-4 text-center hidden">
        <div class="max-w-4xl mx-auto">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <div class="text-left">
                    <p class="text-blue-300 text-sm font-medium mb-1">üîó Multiple Accounts Detected</p>
                    <p id="duplicate-account-message" class="text-blue-200 text-xs"></p>
                </div>
                <div class="flex gap-2">
                    <button id="link-duplicate-accounts-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-2 rounded transition-colors whitespace-nowrap">
                        Link Accounts
                    </button>
                    <button id="dismiss-duplicate-banner-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-xs px-3 py-2 rounded transition-colors whitespace-nowrap">
                        Dismiss
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="min-h-screen bg-gradient-to-br from-slate-950 via-gray-900 to-slate-950">
        <!-- Main Content Container -->
        <div class="container mx-auto px-4 py-8">
            <!-- Logo and Title -->
            <div class="text-center mb-12">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-gold-500 to-yellow-600 rounded-full mb-4">
                    <span class="text-3xl font-bold text-black">ü§º</span>
                </div>
                <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-gold-500 to-yellow-400">
                    wrestling.systems
                </h1>
                <p class="text-gray-400 mt-2">Dashboard</p>
            </div>

            <!-- Loader -->
            <div id="loader-container" class="flex flex-col items-center justify-center min-h-[300px]">
                <div id="loader"></div>
                <p class="mt-4 text-gray-400">Loading Dashboard...</p>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboard-content" class="hidden">
                <!-- Athletes Section -->
                <div class="bg-gray-800/50 rounded-xl p-6 mb-8 border border-gray-700/50">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-white mb-1">Athletes</h2>
                            <p class="text-gray-400">Manage your wrestlers (<span id="athlete-count">0</span>)</p>
                        </div>
                        <button id="show-add-athlete-btn" class="bg-gold-500 hover:bg-gold-600 text-black font-semibold px-6 py-2 rounded-lg transition-colors">
                            Add Wrestler
                        </button>
                    </div>

                    <!-- Add Athlete Form (Hidden by default) -->
                    <div id="add-athlete-section" class="hidden mb-6 p-4 bg-gray-700/30 rounded-lg border border-gray-600/50">
                        <h3 class="text-lg font-semibold text-white mb-4">Add New Wrestler</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">First Name</label>
                                <input type="text" id="athlete-first-name" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-gold-500 focus:border-gold-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Last Name</label>
                                <input type="text" id="athlete-last-name" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-gold-500 focus:border-gold-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Birth Date</label>
                                <input type="date" id="athlete-birth-date" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-gold-500 focus:border-gold-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Gender</label>
                                <select id="athlete-gender" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-gold-500 focus:border-gold-500">
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-300 mb-1">Relationship to You</label>
                                <select id="athlete-relationship" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-gold-500 focus:border-gold-500">
                                    <option value="child">My Child</option>
                                    <option value="athlete">Athlete I Coach</option>
                                    <option value="sibling">My Sibling</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>

                        <div id="add-athlete-error" class="text-red-400 text-sm mb-4 hidden"></div>

                        <div class="flex gap-3">
                            <button id="save-athlete-btn" class="bg-gold-500 hover:bg-gold-600 text-black font-semibold px-6 py-2 rounded-lg transition-colors">
                                Save Wrestler
                            </button>
                            <button id="cancel-add-athlete-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold px-6 py-2 rounded-lg transition-colors">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Athletes List -->
                    <div id="athlete-list" class="space-y-4">
                        <!-- Athletes will be populated here -->
                    </div>

                    <!-- No Athletes Message -->
                    <div id="no-athletes-msg" class="text-center py-8 text-gray-400 hidden">
                        <div class="text-6xl mb-4">ü§º</div>
                        <h3 class="text-xl font-semibold mb-2">No wrestlers yet</h3>
                        <p>Click "Add Wrestler" to get started</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK using traditional script loading -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        console.log("üöÄ WRESTLING SYSTEMS DASHBOARD v2.1 - ATHLETE LOADING FIX üöÄ");
        console.log("Wrestling Systems Dashboard - Clean Version Started");
        
        // Debug system
        window.debugLog = function(message, data = null) {
            console.log(`[DEBUG] ${message}`, data || '');
            const debugDiv = document.getElementById('debug-output') || createDebugDiv();
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'text-xs text-gray-300 mb-1';
            logEntry.innerHTML = `<span class="text-green-400">[${timestamp}]</span> ${message}`;
            debugDiv.appendChild(logEntry);
            if (debugDiv.children.length > 15) {
                debugDiv.removeChild(debugDiv.children[1]);
            }
        };
        
        window.debugError = function(message, error = null) {
            console.error(`[ERROR] ${message}`, error || '');
            const debugDiv = document.getElementById('debug-output') || createDebugDiv();
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'text-xs text-red-300 mb-1';
            logEntry.innerHTML = `<span class="text-red-500">[${timestamp}] ERROR:</span> ${message} ${error ? error.message || error : ''}`;
            debugDiv.appendChild(logEntry);
        };
        
        function createDebugDiv() {
            const debugDiv = document.createElement('div');
            debugDiv.id = 'debug-output';
            debugDiv.className = 'fixed bottom-4 right-4 bg-gray-900 border border-gray-600 p-4 rounded-lg max-w-md w-80 max-h-60 overflow-y-auto text-xs z-50';
            const header = document.createElement('div');
            header.className = 'text-yellow-400 font-bold mb-2 text-sm border-b border-gray-600 pb-2';
            header.innerHTML = 'üêõ Clean Dashboard Debug';
            debugDiv.appendChild(header);
            document.body.appendChild(debugDiv);
            return debugDiv;
        }
        
        debugLog("Debug system initialized");
        
        // Firebase variables
        let auth = null;
        let db = null;
        let currentUser = null;
        
        // DOM elements
        const loaderContainer = document.getElementById('loader-container');
        const dashboardContent = document.getElementById('dashboard-content');
        const userStatusDiv = document.getElementById('user-status');
        const userDisplayName = document.getElementById('user-display-name');
        const userEmailDisplay = document.getElementById('user-email-display');
        const athleteList = document.getElementById('athlete-list');
        const noAthletesMsg = document.getElementById('no-athletes-msg');
        const athleteCount = document.getElementById('athlete-count');
        
        debugLog("DOM elements loaded");
        
        // Wait for Firebase to load
        function waitForFirebase() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                function check() {
                    attempts++;
                    debugLog(`Checking Firebase availability (attempt ${attempts})`);
                    
                    if (typeof firebase !== 'undefined') {
                        debugLog("Firebase global object found");
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        debugError("Firebase failed to load after maximum attempts");
                        reject(new Error('Firebase failed to load'));
                    } else {
                        setTimeout(check, 100);
                    }
                }
                check();
            });
        }
        
        // Initialize Firebase
        waitForFirebase().then(() => {
            debugLog("Firebase available, initializing...");
            
            // Firebase configuration - DEVELOPMENT PROJECT (SAFE)
            const firebaseConfig = {
                apiKey: "AIzaSyDUKOn5OKq9XYwJF-loJ-1E8_P4jaCvnUM",
                authDomain: "wrestling-systems-dev.firebaseapp.com",
                projectId: "wrestling-systems-dev",
                storageBucket: "wrestling-systems-dev.firebasestorage.app",
                messagingSenderId: "115633693255",
                appId: "1:115633693255:web:3ddd3679f2038438c14762"
            };
            
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            debugLog("Firebase initialized successfully");
            
            // Set up authentication listener
            auth.onAuthStateChanged((user) => {
                debugLog("Auth state changed", user ? "User logged in" : "No user");
                
                if (user) {
                    currentUser = user;
                    debugLog("User ID: " + user.uid);
                    
                    // Check for duplicate accounts after successful authentication
                    checkForDuplicateAccounts(user);
                    
                    // Show user info
                    userDisplayName.textContent = user.displayName || user.email;
                    userEmailDisplay.textContent = user.email;
                    userStatusDiv.classList.remove('hidden');
                    
                    // Load dashboard
                    loadDashboard();
                    
                } else {
                    debugLog("No user, redirecting to login");
                    window.location.href = 'https://dev.wrestling.systems/login';
                }
            });
            
            debugLog("Auth listener set up");
            
        }).catch(error => {
            debugError("Firebase initialization failed", error);
            showError("Firebase failed to initialize: " + error.message);
        });
        
        // Load dashboard data
        async function loadDashboard() {
            debugLog("Loading dashboard data");
            
            try {
                // Hide loader, show dashboard
                loaderContainer.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
                debugLog("Dashboard UI shown");
                
                // Load athletes (simplified for now)
                await loadAthletes();
                
                // Set up event listeners
                setupEventListeners();
                
                debugLog("Dashboard fully loaded");
                
            } catch (error) {
                debugError("Error loading dashboard", error);
                showError("Error loading dashboard: " + error.message);
            }
        }
        
        // Load athletes
        async function loadAthletes() {
            debugLog("üîç ATHLETE DEBUG - DETAILED VERSION");
            debugLog("üë§ Current user ID:", currentUser.uid);
            debugLog("üìß Current user email:", currentUser.email);
            
            try {
                // First, let's get ALL athletes (no filter) to see if any exist
                debugLog("üîç Step 1: Querying ALL athletes in database...");
                const allAthletesRef = db.collection('athletes');
                const allAthletesSnapshot = await allAthletesRef.get();
                debugLog(`üìä RESULT: Total athletes in database: ${allAthletesSnapshot.size}`);
                
                if (!allAthletesSnapshot.empty) {
                    debugLog("üë• ALL ATHLETES IN DATABASE:");
                    allAthletesSnapshot.docs.forEach((doc, index) => {
                        const data = doc.data();
                        debugLog(`   ${index + 1}. ${data.firstName} ${data.lastName}`, {
                            id: doc.id,
                            parentUserId: data.parentUserId,
                            matchesCurrentUser: data.parentUserId === currentUser.uid ? "‚úÖ YES" : "‚ùå NO"
                        });
                    });
                } else {
                    debugLog("‚ùå NO athletes found in entire database!");
                }
                
                // Now query for current user's athletes
                debugLog("üîç Step 2: Querying athletes for current user...");
                const athletesRef = db.collection('athletes').where('parentUserId', '==', currentUser.uid);
                const athletesSnapshot = await athletesRef.get();
                debugLog(`üìä RESULT: Athletes for current user: ${athletesSnapshot.size}`);
                
                if (!athletesSnapshot.empty) {
                    debugLog(`‚úÖ Found ${athletesSnapshot.size} athletes for current user:`);
                    athletesSnapshot.docs.forEach((doc, index) => {
                        const data = doc.data();
                        debugLog(`   ${index + 1}. ${data.firstName} ${data.lastName}`, data);
                    });
                    displayAthletes(athletesSnapshot.docs);
                } else {
                    debugLog("‚ùå NO athletes found for current user");
                    debugLog("üîç Possible reasons:");
                    debugLog("   - Athletes exist but have different parentUserId");
                    debugLog("   - No athletes created yet");
                    debugLog("   - Data type mismatch in parentUserId field");
                    showNoAthletes();
                }
                
            } catch (error) {
                debugError("üí• Error loading athletes", error);
                showNoAthletes();
            }
        }
        
        // Display athletes
        function displayAthletes(athleteDocs) {
            athleteList.innerHTML = '';
            noAthletesMsg.classList.add('hidden');
            athleteCount.textContent = athleteDocs.length;
            
            athleteDocs.forEach(doc => {
                const athlete = doc.data();
                const athleteCard = document.createElement('div');
                athleteCard.className = 'bg-gray-800 rounded-lg p-4 border border-gray-700';
                athleteCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-white font-semibold">${athlete.firstName} ${athlete.lastName}</h3>
                            <p class="text-gray-400 text-sm">Age: ${athlete.age}</p>
                            <p class="text-gray-400 text-sm">Weight: ${athlete.weight} lbs</p>
                            <p class="text-gray-400 text-sm">Gender: ${athlete.gender}</p>
                            <p class="text-gray-400 text-sm">Relationship: ${athlete.relationship}</p>
                        </div>
                        <button onclick="deleteAthlete('${doc.id}')" class="text-red-400 hover:text-red-300 text-sm">
                            Delete
                        </button>
                    </div>
                `;
                athleteList.appendChild(athleteCard);
            });
            
            debugLog(`Displayed ${athleteDocs.length} athletes`);
        }

        // Show no athletes message
        function showNoAthletes() {
            athleteList.innerHTML = '';
            noAthletesMsg.classList.remove('hidden');
            athleteCount.textContent = '0';
            debugLog("Showing no athletes message");
        }
        
        // Delete athlete (global function)
        window.deleteAthlete = async function(athleteId) {
            if (!confirm('Are you sure you want to delete this athlete?')) {
                return;
            }
            
            try {
                debugLog(`Deleting athlete: ${athleteId}`);
                await db.collection('athletes').doc(athleteId).delete();
                debugLog("Athlete deleted successfully");
                // Reload athletes list
                loadAthletes();
            } catch (error) {
                debugError("Error deleting athlete", error);
                alert("Error deleting athlete: " + error.message);
            }
        }

        // Show error message
        function showError(message) {
            loaderContainer.classList.add('hidden');
            dashboardContent.innerHTML = `
                <div class="text-center py-8">
                    <div class="bg-red-900/30 border border-red-500/30 rounded-lg p-8 max-w-md mx-auto">
                        <h2 class="text-red-300 font-bold text-xl mb-4">Error</h2>
                        <p class="text-red-200 mb-4">${message}</p>
                        <button onclick="window.location.reload()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                            Reload Page
                        </button>
                    </div>
                </div>
            `;
            dashboardContent.classList.remove('hidden');
        }
        
        // Check for duplicate accounts and show linking option
        async function checkForDuplicateAccounts(user) {
            try {
                // Check if we should look for duplicates
                const shouldCheck = sessionStorage.getItem('checkForDuplicates');
                const newAuthProvider = sessionStorage.getItem('newAuthProvider');
                const newAuthEmail = sessionStorage.getItem('newAuthEmail');
                
                if (!shouldCheck || !newAuthProvider || !newAuthEmail) {
                    debugLog("No duplicate check needed");
                    return;
                }
                
                debugLog("Checking for duplicate accounts...", {
                    newProvider: newAuthProvider,
                    email: newAuthEmail,
                    currentUserEmail: user.email
                });
                
                // Clear the session storage flags
                sessionStorage.removeItem('checkForDuplicates');
                sessionStorage.removeItem('newAuthProvider');
                sessionStorage.removeItem('newAuthEmail');
                
                // Check if there might be other accounts with this email
                if (user.email === newAuthEmail) {
                    // Query Firestore for other users with this email
                    // (This is simplified - in reality you'd need to check Firebase Auth users)
                    
                    // Get current user's provider data
                    const providers = user.providerData.map(p => p.providerId);
                    debugLog("Current user providers:", providers);
                    
                    // If user only has one provider but we just authenticated with a new one,
                    // there might be a duplicate account
                    if (providers.length === 1) {
                        showDuplicateAccountBanner(newAuthProvider, user.email);
                    }
                }
            } catch (error) {
                debugError("Error checking for duplicate accounts:", error);
            }
        }
        
        // Show duplicate account banner
        function showDuplicateAccountBanner(newProvider, email) {
            const banner = document.getElementById('duplicate-account-banner');
            const message = document.getElementById('duplicate-account-message');
            
            const providerName = getProviderDisplayName(newProvider.split('.')[0]);
            
            message.textContent = `You just signed in with ${providerName}. If you have another account with ${email} using a different method (Google, Facebook, Microsoft, or Email & Password), you can link them together.`;
            
            banner.classList.remove('hidden');
            debugLog("Showing duplicate account banner for provider:", newProvider);
        }
        
        // Get user-friendly provider name
        function getProviderDisplayName(provider) {
            switch (provider.toLowerCase()) {
                case 'google': return 'Google';
                case 'facebook': return 'Facebook';
                case 'microsoft': return 'Microsoft';
                case 'email': return 'Email & Password';
                case 'password': return 'Email & Password';
                default: return provider.charAt(0).toUpperCase() + provider.slice(1);
            }
        }
        
        // Handle linking duplicate accounts
        async function handleLinkDuplicateAccounts() {
            try {
                debugLog("User chose to link duplicate accounts");
                
                const user = currentUser;
                if (!user || !user.email) {
                    alert('Error: No user logged in');
                    return;
                }
                
                // Show instructions to user
                const confirmed = confirm(
                    'Link Accounts Instructions:\n\n' +
                    '1. We\'ll try to find other authentication methods for your email\n' +
                    '2. You may be asked to sign in with your other account\n' +
                    '3. Once verified, the accounts will be linked\n\n' +
                    'Continue?'
                );
                
                if (!confirmed) return;
                
                // Try to get existing sign-in methods for this email
                const methods = await firebase.auth().fetchSignInMethodsForEmail(user.email);
                debugLog("Available sign-in methods for", user.email, ":", methods);
                
                if (methods.length <= 1) {
                    alert('No other sign-in methods found for this email. The accounts may already be linked, or there may not be duplicate accounts.');
                    hideDuplicateAccountBanner();
                    return;
                }
                
                // Show available methods to user
                const availableMethods = methods.map(method => {
                    return getProviderDisplayName(method.split('.')[0]);
                }).join(', ');
                
                alert(
                    `Other sign-in methods found: ${availableMethods}\n\n` +
                    'Account linking will happen automatically when you sign in with different providers in the future.\n\n' +
                    'Your accounts are now ready to be linked!'
                );
                
                hideDuplicateAccountBanner();
                
            } catch (error) {
                debugError("Error linking duplicate accounts:", error);
                alert('Error linking accounts: ' + error.message);
            }
        }
        
        // Hide duplicate account banner
        function hideDuplicateAccountBanner() {
            const banner = document.getElementById('duplicate-account-banner');
            banner.classList.add('hidden');
        }

        // Handle data migration request
        async function handleDataMigrationRequest() {
            if (!currentUser) {
                alert('Please sign in to request data migration');
                return;
            }
            
            try {
                // Show confirmation dialog
                const confirmed = confirm(
                    'Request Data Migration?\n\n' +
                    'This will submit a request to migrate your development data to the official Wrestling Systems site when it launches.\n\n' +
                    'Your request will include:\n' +
                    '‚Ä¢ Your account information\n' +
                    '‚Ä¢ All athlete profiles you\'ve created\n' +
                    '‚Ä¢ Tournament registrations (when available)\n\n' +
                    'Continue?'
                );
                
                if (!confirmed) {
                    return;
                }
                
                // Get user's athlete data for request context
                const athletesSnapshot = await db.collection('athletes')
                    .where('parentUserId', '==', currentUser.uid)
                    .get();
                
                const migrationRequest = {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    displayName: currentUser.displayName || 'Unknown',
                    providerData: currentUser.providerData.map(provider => ({
                        providerId: provider.providerId,
                        uid: provider.uid,
                        email: provider.email
                    })),
                    athleteCount: athletesSnapshot.size,
                    requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending',
                    migrationNotes: 'User requested data migration from development to production'
                };
                
                debugLog("Submitting migration request:", migrationRequest);
                
                // Save to migration requests collection
                await db.collection('migrationRequests').add(migrationRequest);
                
                // Update button to show success
                const btn = document.getElementById('request-migration-btn');
                const originalText = btn.textContent;
                btn.textContent = '‚úì Request Submitted';
                btn.disabled = true;
                btn.classList.remove('bg-amber-600', 'hover:bg-amber-700');
                btn.classList.add('bg-green-600');
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                    btn.classList.remove('bg-green-600');
                    btn.classList.add('bg-amber-600', 'hover:bg-amber-700');
                }, 3000);
                
                alert(
                    'Migration Request Submitted Successfully!\n\n' +
                    'Your request has been recorded. When the official Wrestling Systems site launches, we\'ll use this information to migrate your data.\n\n' +
                    'You\'ll receive an email notification when the official site is ready.'
                );
                
                debugLog("Migration request submitted successfully");
                
            } catch (error) {
                debugError("Error submitting migration request", error);
                alert('Error submitting migration request: ' + error.message);
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            debugLog("Setting up event listeners");
            
            // Sign out
            const signOutBtn = document.getElementById('signout-btn');
            if (signOutBtn) {
                signOutBtn.addEventListener('click', async () => {
                    debugLog("Sign out clicked");
                    try {
                        await auth.signOut();
                        debugLog("Successfully signed out");
                        // Redirect to login with logout parameter to prevent redirect loop
                        window.location.href = 'https://dev.wrestling.systems/login?logout=true';
                    } catch (error) {
                        debugError("Sign out error", error);
                    }
                });
            }
            
            // Show/hide add athlete form
            const showAddAthleteBtn = document.getElementById('show-add-athlete-btn');
            const cancelAddAthleteBtn = document.getElementById('cancel-add-athlete-btn');
            const addAthleteSection = document.getElementById('add-athlete-section');
            
            if (showAddAthleteBtn) {
                showAddAthleteBtn.addEventListener('click', () => {
                    debugLog("Show add athlete form");
                    addAthleteSection.classList.remove('hidden');
                });
            }
            
            if (cancelAddAthleteBtn) {
                cancelAddAthleteBtn.addEventListener('click', () => {
                    debugLog("Hide add athlete form");
                    addAthleteSection.classList.add('hidden');
                });
            }
            
            // Save athlete
            const saveAthleteBtn = document.getElementById('save-athlete-btn');
            if (saveAthleteBtn) {
                saveAthleteBtn.addEventListener('click', async () => {
                    debugLog("Save athlete clicked");
                    
                    // Get form values
                    const firstName = document.getElementById('athlete-first-name').value.trim();
                    const lastName = document.getElementById('athlete-last-name').value.trim();
                    const birthDate = document.getElementById('athlete-birth-date').value;
                    const gender = document.getElementById('athlete-gender').value;
                    const relationship = document.getElementById('athlete-relationship').value;
                    
                    // Basic validation
                    if (!firstName || !lastName || !birthDate) {
                        document.getElementById('add-athlete-error').textContent = 'Please fill in all required fields';
                        document.getElementById('add-athlete-error').classList.remove('hidden');
                        return;
                    }
                    
                    // Calculate age
                    const birthYear = new Date(birthDate).getFullYear();
                    const currentYear = new Date().getFullYear();
                    const age = currentYear - birthYear;
                    
                    try {
                        // Hide error message
                        document.getElementById('add-athlete-error').classList.add('hidden');
                        
                        // Save to Firestore
                        const athleteData = {
                            firstName: firstName,
                            lastName: lastName,
                            birthDate: birthDate,
                            age: age,
                            gender: gender,
                            relationship: relationship,
                            parentUserId: currentUser.uid,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        debugLog("Creating athlete with data:", athleteData);
                        await db.collection('athletes').add(athleteData);
                        debugLog("Athlete created successfully");
                        
                        // Clear form
                        document.getElementById('athlete-first-name').value = '';
                        document.getElementById('athlete-last-name').value = '';
                        document.getElementById('athlete-birth-date').value = '';
                        document.getElementById('athlete-gender').value = 'male';
                        document.getElementById('athlete-relationship').value = 'child';
                        
                        // Hide form and reload athletes
                        addAthleteSection.classList.add('hidden');
                        loadAthletes();
                        
                    } catch (error) {
                        debugError("Error adding athlete", error);
                        document.getElementById('add-athlete-error').textContent = 'Error adding athlete: ' + error.message;
                        document.getElementById('add-athlete-error').classList.remove('hidden');
                    }
                });
            }
            
            // Request data migration
            const requestMigrationBtn = document.getElementById('request-migration-btn');
            if (requestMigrationBtn) {
                requestMigrationBtn.addEventListener('click', async () => {
                    debugLog("Request data migration clicked");
                    await handleDataMigrationRequest();
                });
            }
            
            // Duplicate account linking
            const linkDuplicateAccountsBtn = document.getElementById('link-duplicate-accounts-btn');
            if (linkDuplicateAccountsBtn) {
                linkDuplicateAccountsBtn.addEventListener('click', async () => {
                    debugLog("Link duplicate accounts clicked");
                    await handleLinkDuplicateAccounts();
                });
            }
            
            // Dismiss duplicate account banner
            const dismissDuplicateBannerBtn = document.getElementById('dismiss-duplicate-banner-btn');
            if (dismissDuplicateBannerBtn) {
                dismissDuplicateBannerBtn.addEventListener('click', () => {
                    debugLog("Dismiss duplicate banner clicked");
                    hideDuplicateAccountBanner();
                });
            }
            
            debugLog("Event listeners set up");
        }
        
        // Fallback timeout
        setTimeout(() => {
            if (!dashboardContent.classList.contains('hidden')) return;
            
            debugError("Dashboard loading timeout - showing fallback");
            showError("Dashboard took too long to load. Please refresh the page.");
        }, 10000);
        
        debugLog("Clean dashboard script loaded");
    </script>
</body>
</html>