<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Wrestling.Systems</title>

    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://assets.wrestling.systems/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://assets.wrestling.systems/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://assets.wrestling.systems/favicon-16x16.png">
    <link rel="shortcut icon" href="https://assets.wrestling.systems/favicon.ico">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom Gold Color */
        .bg-gold-500 { background-color: #D4AF37; }
        .hover\:bg-gold-600:hover { background-color: #C09B2D; }
        .text-gold-300 { color: #E6C75E; }
        .border-gold-500 { border-color: #D4AF37; }
        .focus\:ring-gold-500:focus { --tw-ring-color: #D4AF37; }
        .focus\:border-gold-500:focus { border-color: #D4AF37; }
        
        #loader {
            border: 5px solid #4b5563;
            border-top: 5px solid #D4AF37;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-black text-gray-200 antialiased">
    
    <!-- User Status Display -->
    <div id="user-status" class="absolute top-4 right-4 text-right hidden group z-10">
        <div class="cursor-pointer">
            <p class="text-gray-400 text-sm">Signed in as</p>
            <p id="user-display-name" class="font-semibold text-white"></p>
        </div>
        <div class="absolute top-full right-0 mt-1 w-max bg-gray-800 rounded-md shadow-lg border border-gray-700 hidden group-hover:block transition-all text-left p-3 z-20">
            <div id="provider-icon-container" class="w-4 h-4 inline-block mr-2"></div>
            <p id="user-email-display" class="text-sm text-gray-300 mb-2"></p>
            <button id="signout-btn" class="bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1 rounded transition-colors">
                Sign Out
            </button>
        </div>
    </div>

    <!-- Email Verification Banner -->
    <div id="email-verification-banner" class="bg-yellow-900/30 border-b border-yellow-500/30 p-3 text-center hidden">
        <div class="max-w-4xl mx-auto">
            <p class="text-yellow-300 text-sm">
                📧 Please verify your email address to use all features. 
                <button id="resend-verification-btn" class="underline hover:no-underline ml-2">Resend Email</button>
            </p>
        </div>
    </div>

    <div class="min-h-screen bg-gradient-to-br from-slate-950 via-gray-900 to-slate-950">
        <!-- Main Content Container -->
        <div class="container mx-auto px-4 py-8">
            <!-- Logo and Title -->
            <div class="text-center mb-12">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-gold-500 to-yellow-600 rounded-full mb-4">
                    <span class="text-3xl font-bold text-black">🤼</span>
                </div>
                <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-gold-500 to-yellow-400">
                    wrestling.systems
                </h1>
                <p class="text-gray-400 mt-2">Dashboard</p>
            </div>

            <!-- Loader -->
            <div id="loader-container" class="flex flex-col items-center justify-center min-h-[300px]">
                <div id="loader"></div>
                <p class="mt-4 text-gray-400">Loading Dashboard...</p>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboard-content" class="hidden">
                <!-- Athletes Section -->
                <div class="bg-gray-800/50 rounded-xl p-6 mb-8 border border-gray-700/50">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-white mb-1">Athletes</h2>
                            <p class="text-gray-400">Manage your wrestlers (<span id="athlete-count">0</span>)</p>
                        </div>
                        <button id="show-add-athlete-btn" class="bg-gold-500 hover:bg-gold-600 text-black font-semibold px-6 py-2 rounded-lg transition-colors">
                            Add Wrestler
                        </button>
                    </div>

                    <!-- Add Athlete Form (Hidden by default) -->
                    <div id="add-athlete-section" class="hidden mb-6 p-4 bg-gray-700/30 rounded-lg border border-gray-600/50">
                        <h3 class="text-lg font-semibold text-white mb-4">Add New Wrestler</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">First Name</label>
                                <input type="text" id="athlete-first-name" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-gold-500 focus:border-gold-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Last Name</label>
                                <input type="text" id="athlete-last-name" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-gold-500 focus:border-gold-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Birth Date</label>
                                <input type="date" id="athlete-birth-date" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-gold-500 focus:border-gold-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Gender</label>
                                <select id="athlete-gender" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-gold-500 focus:border-gold-500">
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-300 mb-1">Relationship to You</label>
                                <select id="athlete-relationship" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:ring-gold-500 focus:border-gold-500">
                                    <option value="child">My Child</option>
                                    <option value="athlete">Athlete I Coach</option>
                                    <option value="sibling">My Sibling</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>

                        <div id="add-athlete-error" class="text-red-400 text-sm mb-4 hidden"></div>

                        <div class="flex gap-3">
                            <button id="save-athlete-btn" class="bg-gold-500 hover:bg-gold-600 text-black font-semibold px-6 py-2 rounded-lg transition-colors">
                                Save Wrestler
                            </button>
                            <button id="cancel-add-athlete-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold px-6 py-2 rounded-lg transition-colors">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Athletes List -->
                    <div id="athlete-list" class="space-y-4">
                        <!-- Athletes will be populated here -->
                    </div>

                    <!-- No Athletes Message -->
                    <div id="no-athletes-msg" class="text-center py-8 text-gray-400 hidden">
                        <div class="text-6xl mb-4">🤼</div>
                        <h3 class="text-xl font-semibold mb-2">No wrestlers yet</h3>
                        <p>Click "Add Wrestler" to get started</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK using traditional script loading -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        console.log("Wrestling Systems Dashboard - Clean Version Started");
        
        // Debug system
        window.debugLog = function(message, data = null) {
            console.log(`[DEBUG] ${message}`, data || '');
            const debugDiv = document.getElementById('debug-output') || createDebugDiv();
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'text-xs text-gray-300 mb-1';
            logEntry.innerHTML = `<span class="text-green-400">[${timestamp}]</span> ${message}`;
            debugDiv.appendChild(logEntry);
            if (debugDiv.children.length > 15) {
                debugDiv.removeChild(debugDiv.children[1]);
            }
        };
        
        window.debugError = function(message, error = null) {
            console.error(`[ERROR] ${message}`, error || '');
            const debugDiv = document.getElementById('debug-output') || createDebugDiv();
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'text-xs text-red-300 mb-1';
            logEntry.innerHTML = `<span class="text-red-500">[${timestamp}] ERROR:</span> ${message} ${error ? error.message || error : ''}`;
            debugDiv.appendChild(logEntry);
        };
        
        function createDebugDiv() {
            const debugDiv = document.createElement('div');
            debugDiv.id = 'debug-output';
            debugDiv.className = 'fixed bottom-4 right-4 bg-gray-900 border border-gray-600 p-4 rounded-lg max-w-md w-80 max-h-60 overflow-y-auto text-xs z-50';
            const header = document.createElement('div');
            header.className = 'text-yellow-400 font-bold mb-2 text-sm border-b border-gray-600 pb-2';
            header.innerHTML = '🐛 Clean Dashboard Debug';
            debugDiv.appendChild(header);
            document.body.appendChild(debugDiv);
            return debugDiv;
        }
        
        debugLog("Debug system initialized");
        
        // Firebase variables
        let auth = null;
        let db = null;
        let currentUser = null;
        
        // DOM elements
        const loaderContainer = document.getElementById('loader-container');
        const dashboardContent = document.getElementById('dashboard-content');
        const userStatusDiv = document.getElementById('user-status');
        const userDisplayName = document.getElementById('user-display-name');
        const userEmailDisplay = document.getElementById('user-email-display');
        const athleteList = document.getElementById('athlete-list');
        const noAthletesMsg = document.getElementById('no-athletes-msg');
        const athleteCount = document.getElementById('athlete-count');
        
        debugLog("DOM elements loaded");
        
        // Wait for Firebase to load
        function waitForFirebase() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                function check() {
                    attempts++;
                    debugLog(`Checking Firebase availability (attempt ${attempts})`);
                    
                    if (typeof firebase !== 'undefined') {
                        debugLog("Firebase global object found");
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        debugError("Firebase failed to load after maximum attempts");
                        reject(new Error('Firebase failed to load'));
                    } else {
                        setTimeout(check, 100);
                    }
                }
                check();
            });
        }
        
        // Initialize Firebase
        waitForFirebase().then(() => {
            debugLog("Firebase available, initializing...");
            
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyASn9xe5RRKFGXNi-Vha-NunDYj1mv7D3g",
                authDomain: "auth.wrestling.systems",
                projectId: "wrestlingsystems",
                storageBucket: "wrestlingsystems.appspot.com",
                messagingSenderId: "255692661115",
                appId: "1:255692661115:web:7ad4f8d39b78fb1220ddde",
                measurementId: "G-E52GDENT1E"
            };
            
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            debugLog("Firebase initialized successfully");
            
            // Set up authentication listener
            auth.onAuthStateChanged((user) => {
                debugLog("Auth state changed", user ? "User logged in" : "No user");
                
                if (user) {
                    currentUser = user;
                    debugLog("User ID: " + user.uid);
                    
                    // Show user info
                    userDisplayName.textContent = user.displayName || user.email;
                    userEmailDisplay.textContent = user.email;
                    userStatusDiv.classList.remove('hidden');
                    
                    // Load dashboard
                    loadDashboard();
                    
                } else {
                    debugLog("No user, redirecting to login");
                    window.location.href = 'https://dev.wrestling.systems/login';
                }
            });
            
            debugLog("Auth listener set up");
            
        }).catch(error => {
            debugError("Firebase initialization failed", error);
            showError("Firebase failed to initialize: " + error.message);
        });
        
        // Load dashboard data
        async function loadDashboard() {
            debugLog("Loading dashboard data");
            
            try {
                // Hide loader, show dashboard
                loaderContainer.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
                debugLog("Dashboard UI shown");
                
                // Load athletes (simplified for now)
                await loadAthletes();
                
                // Set up event listeners
                setupEventListeners();
                
                debugLog("Dashboard fully loaded");
                
            } catch (error) {
                debugError("Error loading dashboard", error);
                showError("Error loading dashboard: " + error.message);
            }
        }
        
        // Load athletes
        async function loadAthletes() {
            debugLog("Loading athletes");
            
            try {
                const userRef = db.collection('users').doc(currentUser.uid);
                const userDoc = await userRef.get();
                
                if (userDoc.exists()) {
                    debugLog("User document exists");
                    // For now, just show no athletes message
                    showNoAthletes();
                } else {
                    debugLog("User document does not exist");
                    showNoAthletes();
                }
                
            } catch (error) {
                debugError("Error loading athletes", error);
                showNoAthletes();
            }
        }
        
        // Show no athletes message
        function showNoAthletes() {
            athleteList.innerHTML = '';
            noAthletesMsg.classList.remove('hidden');
            athleteCount.textContent = '0';
            debugLog("Showing no athletes message");
        }
        
        // Show error message
        function showError(message) {
            loaderContainer.classList.add('hidden');
            dashboardContent.innerHTML = `
                <div class="text-center py-8">
                    <div class="bg-red-900/30 border border-red-500/30 rounded-lg p-8 max-w-md mx-auto">
                        <h2 class="text-red-300 font-bold text-xl mb-4">Error</h2>
                        <p class="text-red-200 mb-4">${message}</p>
                        <button onclick="window.location.reload()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                            Reload Page
                        </button>
                    </div>
                </div>
            `;
            dashboardContent.classList.remove('hidden');
        }
        
        // Set up event listeners
        function setupEventListeners() {
            debugLog("Setting up event listeners");
            
            // Sign out
            const signOutBtn = document.getElementById('signout-btn');
            if (signOutBtn) {
                signOutBtn.addEventListener('click', () => {
                    debugLog("Sign out clicked");
                    auth.signOut();
                });
            }
            
            // Show/hide add athlete form
            const showAddAthleteBtn = document.getElementById('show-add-athlete-btn');
            const cancelAddAthleteBtn = document.getElementById('cancel-add-athlete-btn');
            const addAthleteSection = document.getElementById('add-athlete-section');
            
            if (showAddAthleteBtn) {
                showAddAthleteBtn.addEventListener('click', () => {
                    debugLog("Show add athlete form");
                    addAthleteSection.classList.remove('hidden');
                });
            }
            
            if (cancelAddAthleteBtn) {
                cancelAddAthleteBtn.addEventListener('click', () => {
                    debugLog("Hide add athlete form");
                    addAthleteSection.classList.add('hidden');
                });
            }
            
            debugLog("Event listeners set up");
        }
        
        // Fallback timeout
        setTimeout(() => {
            if (!dashboardContent.classList.contains('hidden')) return;
            
            debugError("Dashboard loading timeout - showing fallback");
            showError("Dashboard took too long to load. Please refresh the page.");
        }, 10000);
        
        debugLog("Clean dashboard script loaded");
    </script>
</body>
</html>