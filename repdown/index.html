<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rep Down - Wrestling.Systems</title>

    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://assets.wrestling.systems/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://assets.wrestling.systems/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://assets.wrestling.systems/favicon-16x16.png">
    <link rel="shortcut icon" href="https://assets.wrestling.systems/favicon.ico">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Custom Gold Color */
        .bg-gold-500 { background-color: #D4AF37; }
        .hover\:bg-gold-600:hover { background-color: #C09B2D; }
        .text-gold-300 { color: #E6C75E; }
        .border-gold-500 { border-color: #D4AF37; }
        .focus\:ring-gold-500:focus { --tw-ring-color: #D4AF37; }
        .focus\:border-gold-500:focus { border-color: #D4AF37; }
        .text-gold-400 { color: #D4AF37; } /* A slightly darker gold for main buttons */
        .hover\:text-gold-300:hover { color: #E6C75E; }

        #loader {
            border: 5px solid #4b5563; /* gray-600 */
            border-top: 5px solid #D4AF37; /* gold-500 */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-black text-gray-200 antialiased">
    
    <!-- User Status Display -->
    <div id="user-status" class="absolute top-4 right-4 text-right hidden group z-10">
        <div class="cursor-pointer">
            <p class="text-gray-400 text-sm">Signed in as</p>
            <p id="user-display-name" class="font-semibold text-white"></p>
        </div>
        <div class="absolute top-full right-0 mt-1 w-max bg-gray-800 rounded-md shadow-lg border border-gray-700 hidden group-hover:block transition-all text-left p-3 z-20">
            <div class="flex items-center gap-2 border-b border-gray-600 pb-2 mb-2">
                <span id="provider-icon-container" class="w-5 h-5"></span>
                <span id="user-email-display" class="text-gray-300 text-sm"></span>
            </div>
            <button id="signout-btn" class="w-full text-left text-red-400 font-semibold hover:text-red-300">Sign Out</button>
        </div>
    </div>


    <!-- Main Container -->
    <div class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-b from-black to-gray-900 p-4">

        <div class="w-full max-w-lg mx-auto text-center pt-12">
            <!-- Logo/Header -->
            <a href="https://dev.wrestling.systems"><img src="https://assets.wrestling.systems/logo-gemini2.png" alt="Wrestling.Systems Logo" class="w-48 mx-auto mb-6"></a>
        </div>

        <div id="app-container" class="w-full max-w-lg mx-auto bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-2xl p-6 sm:p-8 border border-gray-700 mt-8">
            
            <div id="loader-container" class="flex flex-col items-center justify-center min-h-[400px]">
                <div id="loader"></div>
                <p class="mt-4 text-gold-300">Connecting...</p>
            </div>

            <!-- Setup Screen -->
            <div id="setup-screen" class="hidden">
                <h1 class="text-3xl sm:text-4xl font-bold text-white text-center mb-2">Rep Down Challenge</h1>
                <p id="retry-info" class="text-cyan-400 text-lg my-3 text-center hidden"></p>
                <p id="current-date" class="text-gray-400 text-base text-center mb-1"></p>
                <p id="challenge-day-info" class="text-gold-300 font-bold text-xl text-center mb-4"></p>
                
                <div class="bg-black/30 p-6 rounded-xl">
                    <p id="recommended-reps" class="text-gray-300 text-base text-center mb-5"></p>
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-300 mb-3 text-center">Select Your Exercises</label>
                        <div id="exercise-selection" class="space-y-2 text-left w-fit mx-auto">
                            <div class="flex items-center">
                                <input id="pushups-check" type="checkbox" checked value="Pushups" class="w-4 h-4 text-gold-500 bg-gray-700 border-gray-600 rounded focus:ring-gold-500 focus:ring-2">
                                <label for="pushups-check" class="ml-2 text-base font-medium text-gray-300">Pushups</label>
                            </div>
                            <div class="flex items-center">
                                <input id="squats-check" type="checkbox" checked value="Squats" class="w-4 h-4 text-gold-500 bg-gray-700 border-gray-600 rounded focus:ring-gold-500 focus:ring-2">
                                <label for="squats-check" class="ml-2 text-base font-medium text-gray-300">Squats</label>
                            </div>
                            <div class="flex items-center">
                                <input id="vups-check" type="checkbox" checked value="V-ups" class="w-4 h-4 text-gold-500 bg-gray-700 border-gray-600 rounded focus:ring-gold-500 focus:ring-2">
                                <label for="vups-check" class="ml-2 text-base font-medium text-gray-300">V-ups</label>
                            </div>
                        </div>
                        <div id="add-exercise-container" class="mt-3 text-center">
                            <button id="add-exercise-btn" class="text-cyan-400 hover:text-cyan-300 text-sm font-semibold">+ Add Exercise</button>
                            <div id="new-exercise-form" class="hidden mt-2 flex gap-2 w-full max-w-xs mx-auto">
                                <input type="text" id="new-exercise-input" placeholder="Exercise Name" class="flex-grow bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-gold-500 focus:border-gold-500">
                                <button id="save-exercise-btn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-3 rounded-md text-sm">Save</button>
                            </div>
                            <p id="add-exercise-limit-msg" class="text-gray-500 text-xs mt-2 hidden">You can add up to 2 custom exercises.</p>
                        </div>
                        <p id="exercise-error" class="text-red-400 text-sm mt-2 text-center hidden">Please select at least one exercise.</p>
                    </div>
                    <div class="mb-4">
                        <label for="reps-input" class="block text-sm font-medium text-gray-300 mb-2 text-center">Starting Reps</label>
                        <input type="number" id="reps-input" value="10" min="1" max="100" class="w-full text-center bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white text-2xl font-bold focus:outline-none focus:ring-gold-500 focus:border-gold-500">
                        <p id="reps-error" class="text-red-400 text-sm mt-2 text-center hidden">Please enter a number between 1 and 100.</p>
                    </div>
                    <button id="start-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm font-medium text-white bg-gold-500 hover:bg-gold-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gold-500 focus:ring-offset-gray-900 transition-all duration-300">
                        Start Workout
                    </button>
                </div>
            </div>

            <!-- Workout Screen -->
            <div id="workout-screen" class="hidden">
                <div id="total-timer-container" class="mb-4 text-center">
                    <p class="text-gray-400 text-sm font-medium">Time Remaining for this Round</p>
                    <p id="total-timer" class="text-4xl font-bold text-gray-200">10:00</p>
                </div>
                <div id="rep-display" class="mb-4 text-center">
                    <p class="text-gray-400 text-lg font-medium">Current Round</p>
                    <p id="current-reps" class="text-7xl font-extrabold text-gold-300">10</p>
                    <p class="text-gray-400 text-lg font-medium">Reps per Exercise</p>
                </div>

                <div id="exercise-list" class="my-6 bg-black/30 p-4 rounded-xl">
                    <h3 class="text-lg font-bold text-white text-center mb-4">Complete Your Reps:</h3>
                    <div id="dynamic-exercise-list" class="space-y-3">
                        <!-- Dynamic content will be injected here -->
                    </div>
                </div>

                <button id="done-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm font-medium text-white bg-gold-500 hover:bg-gold-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gold-500 focus:ring-offset-gray-900 transition-all duration-300">
                    Start Next Round
                </button>
                <button id="end-btn" class="w-full mt-3 bg-transparent hover:bg-red-600 text-red-500 hover:text-white font-medium text-sm py-2 px-4 rounded-md border border-red-500/50 hover:border-red-500 transition-colors">
                    End Workout
                </button>
            </div>

            <!-- Completion Screen -->
            <div id="complete-screen" class="hidden">
                <h1 id="complete-title" class="text-3xl font-extrabold text-gold-300 mb-3 text-center">Well Done!</h1>
                <p class="text-gray-400 text-base mb-5 text-center">You crushed the challenge. Time to recover.</p>
                <p id="total-reps-info" class="text-gold-300 text-xl font-bold mb-1 text-center"></p>
                <p id="total-missed-reps-info" class="text-red-400 text-base font-bold mb-1 text-center hidden"></p>
                <p id="beast-mode-info" class="text-cyan-400 text-xl font-bold mb-3 text-center hidden"></p>
                <div id="round-summary-container" class="my-5 text-left max-h-52 overflow-y-auto bg-black/30 p-4 rounded-xl">
                    <h3 class="text-base font-bold text-white mb-2 text-center">Round Summary</h3>
                    <div id="round-summary-list"></div>
                </div>
                <button id="restart-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm font-medium text-white bg-gold-500 hover:bg-gold-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gold-500 focus:ring-offset-gray-900 transition-all duration-300">
                    New Workout
                </button>
                <div class="mt-3 grid grid-cols-2 gap-3">
                    <button id="download-csv-btn" class="w-full bg-transparent hover:bg-green-600 text-green-500 hover:text-white font-medium text-sm py-2 px-4 rounded-md border border-green-500/50 hover:border-green-500 transition-colors hidden">
                        Download CSV
                    </button>
                    <button id="retry-btn" class="w-full bg-transparent hover:bg-cyan-500 text-cyan-400 hover:text-black font-medium text-sm py-2 px-4 rounded-md border border-cyan-400/50 hover:border-cyan-400 transition-colors hidden">
                        Retry Workout
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center text-gray-500 mt-12 pb-8 space-y-2">
             <p class="text-sm">&copy; 2025 Wrestling.Systems. All Rights Reserved.</p>
        </footer>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM Elements
        const setupScreen = document.getElementById('setup-screen');
        const workoutScreen = document.getElementById('workout-screen');
        const completeScreen = document.getElementById('complete-screen');
        const loaderContainer = document.getElementById('loader-container');
        
        const userStatusDiv = document.getElementById('user-status');
        const userDisplayName = document.getElementById('user-display-name');
        const userEmailDisplay = document.getElementById('user-email-display');
        const providerIconContainer = document.getElementById('provider-icon-container');
        const signOutBtn = document.getElementById('signout-btn');
        
        const repsInput = document.getElementById('reps-input');
        const startBtn = document.getElementById('start-btn');
        const doneBtn = document.getElementById('done-btn');
        const restartBtn = document.getElementById('restart-btn');
        const endBtn = document.getElementById('end-btn');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        const retryBtn = document.getElementById('retry-btn');
        
        const repsError = document.getElementById('reps-error');
        const exerciseError = document.getElementById('exercise-error');
        const exerciseSelection = document.getElementById('exercise-selection');
        const dynamicExerciseList = document.getElementById('dynamic-exercise-list');

        const addExerciseBtn = document.getElementById('add-exercise-btn');
        const newExerciseForm = document.getElementById('new-exercise-form');
        const newExerciseInput = document.getElementById('new-exercise-input');
        const saveExerciseBtn = document.getElementById('save-exercise-btn');
        const addExerciseLimitMsg = document.getElementById('add-exercise-limit-msg');

        const currentRpsDisplay = document.getElementById('current-reps');
        const totalTimerDisplay = document.getElementById('total-timer');
        const challengeDayInfo = document.getElementById('challenge-day-info');
        const currentDateDisplay = document.getElementById('current-date');
        const recommendedRepsDisplay = document.getElementById('recommended-reps');
        const retryInfoDisplay = document.getElementById('retry-info');
        const roundSummaryList = document.getElementById('round-summary-list');
        
        // App State
        let startingRps = 10;
        let currentReps = 10;
        let totalTimerInterval;
        let selectedExercises = [];
        let exerciseStates = {};
        let totalRepsCompleted = 0;
        let missedRepsByExercise = {};
        let recommendedReps = 0;
        let totalRecommendedReps = 0;
        let previousAttemptCompleted = 0;
        let previousAttemptMissedByExercise = {};
        let roundStartTime;
        let roundTimes = [];
        let customExercisesAdded = 0;

        // Firebase State
        let app, auth, db, userId;
        const appId = 'rep-down-challenge';

        // --- Helper Functions ---
        function getProviderIcon(providerId) {
            switch (providerId) {
                case 'google.com':
                    return `<svg class="w-full h-full text-gold-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 21.2 172.9 60.3L360 128.2c-23.2-21.5-58.2-34.6-112-34.6-88.6 0-161.2 71.5-161.2 162.3s72.6 162.3 161.2 162.3c98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 26.9 3.9 41.4z"></path></svg>`;
                case 'facebook.com':
                    return `<svg class="w-full h-full text-gold-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"></path></svg>`;
                case 'microsoft.com':
                    return `<svg class="w-full h-full text-gold-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 32h192v192H0V32zm256 0h192v192H256V32zM0 288h192v192H0V288zm256 288h192v-96H256v96zm0-128h192v-96H256v96z"></path></svg>`;
                case 'password':
                default:
                    return `<svg class="w-full h-full text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"></path></svg>`;
            }
        }

        // --- Firebase Initialization ---
        async function initFirebase() {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyASn9xe5RRKFGXNi-Vha-NunDYj1mv7D3g",
                    authDomain: "auth.wrestling.systems",
                    projectId: "wrestlingsystems",
                    storageBucket: "wrestlingsystems.appspot.com",
                    messagingSenderId: "255692661115",
                    appId: "1:255692661115:web:7ad4f8d39b78fb1220ddde",
                    measurementId: "G-E52GDENT1E"
                };

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        
                        const userRef = doc(db, "users", userId);
                        try {
                            const docSnap = await getDoc(userRef);
                            if (docSnap.exists() && docSnap.data().firstName) {
                                userDisplayName.textContent = `Hello, ${docSnap.data().firstName}`;
                            } else {
                                userDisplayName.textContent = user.displayName || user.email;
                            }
                        } catch (error) {
                            console.error("Error fetching user data:", error);
                            userDisplayName.textContent = user.displayName || user.email;
                        }

                        // Populate user details dropdown
                        const providerId = user.providerData[0]?.providerId || 'password';
                        providerIconContainer.innerHTML = getProviderIcon(providerId);
                        userEmailDisplay.textContent = user.email;
                        
                        userStatusDiv.classList.remove('hidden');
                        await fetchLastWorkout();
                        loaderContainer.classList.add('hidden');
                        setupScreen.classList.remove('hidden');

                    } else {
                        userStatusDiv.classList.add('hidden');
                        loaderContainer.innerHTML = `
                             <div class="p-4 text-center">
                                <p class="text-lg text-gold-300">
                                    Please sign in to your<br>
                                    <span class="font-bold">wrestling.systems</span>
                                    account to use this app.
                                </p>
                                <div class="mt-6 flex flex-col sm:flex-row gap-3">
                                    <a href="https://dev.wrestling.systems/login" class="w-full flex justify-center py-2.5 px-4 border border-transparent rounded-md shadow-sm font-medium text-black bg-gold-500 hover:bg-gold-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gold-500 focus:ring-offset-gray-900 transition-all duration-300">
                                        Sign In
                                    </a>
                                    <a href="https://dev.wrestling.systems/register" class="w-full flex justify-center py-2.5 px-4 border border-gray-600 rounded-md shadow-sm font-medium text-white bg-gray-700 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gold-500 focus:ring-offset-gray-900 transition-all duration-300">
                                        Register
                                    </a>
                                </div>
                            </div>`;
                        loaderContainer.classList.remove('hidden');
                        setupScreen.classList.add('hidden');
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loaderContainer.innerHTML = '<p class="text-red-500">Error connecting to server. Please refresh.</p>';
            }
        }

        async function fetchLastWorkout() {
            if (!userId) return;
            try {
                const workoutsRef = collection(db, `artifacts/${appId}/users/${userId}/workouts`);
                const q = query(workoutsRef, orderBy("createdAt", "desc"), limit(1));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const lastWorkout = querySnapshot.docs[0].data();
                    if (lastWorkout.status === 'incomplete') {
                        previousAttemptCompleted = lastWorkout.totalRepsCompleted || 0;
                        previousAttemptMissedByExercise = lastWorkout.missedRepsByExercise || {};
                        
                        if (previousAttemptCompleted > 0) {
                             retryInfoDisplay.textContent = `Found an incomplete workout! ${previousAttemptCompleted} reps will be added when you retry.`;
                             retryInfoDisplay.classList.remove('hidden');
                        }
                    }
                }
            } catch (error) {
                console.error("Error fetching last workout:", error);
            }
        }

        async function saveWorkoutData(status) {
            if (!userId) return;
            try {
                const workoutData = {
                    status: status,
                    createdAt: serverTimestamp(),
                    startingReps: startingRps,
                    selectedExercises: selectedExercises,
                    roundTimes: roundTimes,
                    totalRepsCompleted: totalRepsCompleted,
                    missedRepsByExercise: missedRepsByExercise,
                    previousAttemptCompleted: previousAttemptCompleted,
                    previousAttemptMissedByExercise: previousAttemptMissedByExercise
                };
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/workouts`), workoutData);
                console.log("Workout data saved successfully.");
            } catch (error) {
                console.error("Error saving workout data:", error);
            }
        }

        function sumOfN(n) {
            if (n <= 0) return 0;
            return n * (n + 1) / 2;
        }

        function formatRoundTime(seconds) {
            if (seconds < 60) return `${Math.floor(seconds)}s`;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}m ${remainingSeconds}s`;
        }
        
        function getFinalTotals() {
            const finalCompleted = totalRepsCompleted + previousAttemptCompleted;

            const finalMissedByExercise = { ...previousAttemptMissedByExercise };
            Object.keys(missedRepsByExercise).forEach(ex => {
                finalMissedByExercise[ex] = (finalMissedByExercise[ex] || 0) + missedRepsByExercise[ex];
            });
            
            const totalFinalMissed = Object.values(finalMissedByExercise).reduce((sum, count) => sum + count, 0);

            const beastModeReps = finalCompleted - totalRecommendedReps;

            return { finalCompleted, finalMissedByExercise, totalFinalMissed, beastModeReps };
        }

        // --- Core App Logic ---
        function updateChallengeInfo() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
            currentDateDisplay.textContent = `Today is ${today.toLocaleDateString(undefined, dateOptions)}.`;
            const currentYear = today.getFullYear();
            const startDate = new Date(currentYear, 8, 10);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 19);
            let defaultReps = 10;
            if (today < startDate) {
                challengeDayInfo.textContent = `Challenge starts on 09/10.`;
            } else if (today > endDate) {
                challengeDayInfo.textContent = `The 20-Day Challenge has ended.`;
            } else {
                const timeDiff = today.getTime() - startDate.getTime();
                const dayNumber = Math.floor(timeDiff / (1000 * 3600 * 24)) + 1;
                defaultReps = 10 + (dayNumber - 1);
                challengeDayInfo.textContent = `Day ${dayNumber} of 20`;
            }
            recommendedReps = defaultReps;
            repsInput.value = defaultReps;
            recommendedRepsDisplay.textContent = `Recommended start for today: ${recommendedReps} reps.`;
        }

        function validateInputs() {
            let isValid = true;
            const reps = parseInt(repsInput.value);
            if (isNaN(reps) || reps < 1 || reps > 100) {
                repsError.classList.remove('hidden');
                isValid = false;
            } else {
                repsError.classList.add('hidden');
            }
            const allCheckboxes = document.querySelectorAll('#exercise-selection input[type="checkbox"]');
            selectedExercises = Array.from(allCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
            if (selectedExercises.length === 0) {
                exerciseError.classList.remove('hidden');
                isValid = false;
            } else {
                exerciseError.classList.add('hidden');
            }
            return isValid;
        }

        function startWorkout() {
            if (!validateInputs()) return;
            startingRps = parseInt(repsInput.value);
            currentReps = startingRps;
            totalRepsCompleted = 0;
            missedRepsByExercise = {};
            roundTimes = [];
            totalRecommendedReps = sumOfN(recommendedReps) * selectedExercises.length;
            exerciseStates = {};
            selectedExercises.forEach(name => {
                exerciseStates[name] = startingRps;
                missedRepsByExercise[name] = 0;
            });
            updateRepDisplay();
            buildExerciseTrackers();
            startTotalTimer();
            updateDoneButtonText();
            setupScreen.classList.add('hidden');
            workoutScreen.classList.remove('hidden');
            completeScreen.classList.add('hidden');
        }

        function buildExerciseTrackers() {
            dynamicExerciseList.innerHTML = '';
            selectedExercises.forEach(exerciseName => {
                const exerciseReps = exerciseStates[exerciseName];
                const isOnTarget = exerciseReps === currentReps;
                const repsBehind = exerciseReps - currentReps;
                const item = document.createElement('div');
                item.className = 'exercise-item text-left bg-gray-900/50 p-3 rounded-md';
                item.dataset.name = exerciseName;
                item.dataset.completed = 'false';
                
                let statusHTML;
                if (isOnTarget) {
                    statusHTML = `<span class="text-green-400 font-semibold">On Target</span>`;
                } else {
                    statusHTML = `<span class="text-yellow-400 font-semibold">You're on ${exerciseReps}, catch up!</span>`;
                }

                let buttonClasses;
                if (isOnTarget) buttonClasses = 'bg-gold-500 hover:bg-gold-600 text-black';
                else if (repsBehind > 0 && repsBehind <= 3) buttonClasses = 'bg-yellow-600 hover:bg-yellow-500 text-black';
                else if (repsBehind > 3) buttonClasses = 'bg-red-600 hover:bg-red-500 text-white';

                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="exercise-name text-base font-medium text-gray-300 block">${exerciseName}</span>
                            <span class="exercise-status text-xs">${statusHTML}</span>
                        </div>
                        <button class="complete-exercise-btn ${buttonClasses} font-bold py-1.5 px-3 rounded-md transition-colors text-sm">Done</button>
                    </div>`;
                dynamicExerciseList.appendChild(item);
                item.querySelector('.complete-exercise-btn').onclick = () => markExerciseComplete(item);
            });
        }

        function updateSingleExerciseTracker(item) {
            const exerciseName = item.dataset.name;
            const exerciseReps = exerciseStates[exerciseName];
            const isOnTarget = exerciseReps === currentReps;
            const repsBehind = exerciseReps - currentReps;
            item.querySelector('.exercise-status').innerHTML = isOnTarget ? `<span class="text-green-400 font-semibold">On Target</span>` : `<span class="text-yellow-400 font-semibold">You're on ${exerciseReps}, catch up!</span>`;
            
            const button = item.querySelector('.complete-exercise-btn');
            button.classList.remove('bg-gold-500', 'hover:bg-gold-600', 'bg-yellow-600', 'hover:bg-yellow-500', 'bg-red-600', 'hover:bg-red-500', 'text-white', 'text-black');
            
            if (isOnTarget) button.classList.add('bg-gold-500', 'hover:bg-gold-600', 'text-black');
            else if (repsBehind > 0 && repsBehind <= 3) button.classList.add('bg-yellow-600', 'hover:bg-yellow-500', 'text-black');
            else if (repsBehind > 3) button.classList.add('bg-red-600', 'hover:bg-red-500', 'text-white');
        }

        function markExerciseComplete(item) {
            const name = item.dataset.name;
            const exerciseReps = exerciseStates[name];
            if (exerciseReps > currentReps) {
                exerciseStates[name]--;
                totalRepsCompleted++;
                updateSingleExerciseTracker(item);
            } else if (exerciseReps === currentReps) {
                item.dataset.completed = 'true';
                const button = item.querySelector('.complete-exercise-btn');
                button.disabled = true;
                button.textContent = '✔';
                button.classList.remove('bg-gold-500', 'hover:bg-gold-600', 'bg-yellow-600', 'hover:bg-yellow-500', 'bg-red-600', 'hover:bg-red-500', 'text-white', 'text-black');
                button.classList.add('bg-green-600', 'text-white');
            }
        }

        function completeRound() {
            const roundEndTime = Date.now();
            const timeTaken = (roundEndTime - roundStartTime) / 1000;
            const exerciseItems = dynamicExerciseList.querySelectorAll('.exercise-item');
            const allDone = Array.from(exerciseItems).every(item => item.dataset.completed === 'true');
            const missedRepsInRound = {};
            exerciseItems.forEach(item => {
                if (item.dataset.completed !== 'true') missedRepsInRound[item.dataset.name] = exerciseStates[item.dataset.name];
            });
            roundTimes.push({ roundNumber: currentReps, timeTaken: timeTaken, status: allDone ? 'Completed' : 'Started Early', missedReps: missedRepsInRound });
            exerciseItems.forEach(item => {
                const name = item.dataset.name;
                const isCompletedThisRound = item.dataset.completed === 'true';
                const repsForThisExercise = exerciseStates[name];
                if (isCompletedThisRound) {
                    totalRepsCompleted += repsForThisExercise;
                    exerciseStates[name] = currentReps - 1;
                } else {
                    missedRepsByExercise[name] += repsForThisExercise;
                }
            });
            currentReps--;
            if (currentReps <= 0) {
                finishWorkout();
                return;
            }
            updateRepDisplay();
            buildExerciseTrackers();
            startTotalTimer();
            updateDoneButtonText();
        }

        function endWorkout() {
            clearInterval(totalTimerInterval);
            const roundEndTime = Date.now();
            const timeTaken = (roundEndTime - roundStartTime) / 1000;
            const exerciseItems = dynamicExerciseList.querySelectorAll('.exercise-item');
            const missedRepsInRound = {};
            exerciseItems.forEach(item => {
                if (item.dataset.completed !== 'true') missedRepsInRound[item.dataset.name] = exerciseStates[item.dataset.name];
            });
            roundTimes.push({ roundNumber: currentReps, timeTaken: timeTaken, status: 'Ended Early', missedReps: missedRepsInRound });
            exerciseItems.forEach(item => {
                const name = item.dataset.name;
                const isCompletedThisRound = item.dataset.completed === 'true';
                if (!isCompletedThisRound) missedRepsByExercise[name] += exerciseStates[name];
                else totalRepsCompleted += exerciseStates[name];
            });
            if (currentReps > 1) {
                const repsInFutureRounds = sumOfN(currentReps - 1);
                selectedExercises.forEach(name => {
                    missedRepsByExercise[name] += repsInFutureRounds;
                });
            }
            showIncompleteScreen();
            saveWorkoutData('incomplete');
        }

        function displayRoundSummary() {
            roundSummaryList.innerHTML = '';
            if (roundTimes.length === 0) return;
            roundTimes.forEach(round => {
                const statusColor = round.status === 'Completed' ? 'text-green-400' : (round.status === 'Started Early' ? 'text-yellow-400' : 'text-red-500');
                const summaryItem = document.createElement('div');
                summaryItem.className = 'text-gray-300 py-1.5 border-b border-gray-700/50 text-sm';
                let missedRepsHTML = '';
                const missedEntries = Object.entries(round.missedReps || {});
                if (missedEntries.length > 0) {
                    const missedContent = missedEntries.map(([exercise, reps]) => `<span>- Missed ${reps} ${exercise}</span>`).join('<br>');
                    missedRepsHTML = `<div class="text-xs text-red-400 pl-4 pt-1">${missedContent}</div>`;
                }
                summaryItem.innerHTML = `<div class="flex justify-between items-center"><span>Round <span class="font-bold text-gold-300">${round.roundNumber}</span></span><span class="font-semibold">${formatRoundTime(round.timeTaken)}</span><span class="font-bold ${statusColor}">${round.status}</span></div>${missedRepsHTML}`;
                roundSummaryList.appendChild(summaryItem);
            });
        }

        function downloadCSV() {
            if (roundTimes.length === 0) return;
            let csvContent = "Round,Time Taken (seconds),Status\n";
            roundTimes.forEach(round => {
                csvContent += `${round.roundNumber},${round.timeTaken.toFixed(2)},"${round.status}"\n`;
            });
            csvContent += "\nMetric,Value\n";
            const { finalCompleted, finalMissedByExercise, beastModeReps } = getFinalTotals();
            csvContent += `Total Reps Completed,${finalCompleted}\n`;
            for (const [exercise, count] of Object.entries(finalMissedByExercise)) {
                if (count > 0) csvContent += `Missed ${exercise} Reps,${count}\n`;
            }
            if (beastModeReps > 0) csvContent += `Beast Mode Reps,${beastModeReps}\n`;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                const today = new Date();
                const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                link.setAttribute("href", url);
                link.setAttribute("download", `rep_down_summary_${dateString}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function showIncompleteScreen() {
            document.title = 'Rep Down';
            const { finalCompleted, totalFinalMissed } = getFinalTotals();
            document.getElementById('complete-title').textContent = "Workout Incomplete";
            document.getElementById('total-reps-info').textContent = `Total Reps Completed: ${finalCompleted}`;
            const totalMissedRepsInfo = document.getElementById('total-missed-reps-info');
            if (totalFinalMissed > 0) {
                totalMissedRepsInfo.textContent = `Total Reps Missed: ${totalFinalMissed}`;
                totalMissedRepsInfo.classList.remove('hidden');
            } else {
                totalMissedRepsInfo.classList.add('hidden');
            }
            document.getElementById('beast-mode-info').classList.add('hidden');
            restartBtn.classList.remove('hidden');
            retryBtn.classList.remove('hidden');
            downloadCsvBtn.classList.remove('hidden');
            displayRoundSummary();
            workoutScreen.classList.add('hidden');
            completeScreen.classList.remove('hidden');
        }

        function retryWorkout() {
            previousAttemptCompleted += totalRepsCompleted;
            Object.keys(missedRepsByExercise).forEach(ex => {
                previousAttemptMissedByExercise[ex] = (previousAttemptMissedByExercise[ex] || 0) + missedRepsByExercise[ex];
            });
            roundTimes = [];
            resetApp();
        }

        function finishWorkout() {
            clearInterval(totalTimerInterval);
            document.title = 'Rep Down';
            const { finalCompleted, totalFinalMissed, beastModeReps } = getFinalTotals();
            document.getElementById('complete-title').textContent = "Well Done!";
            document.getElementById('total-reps-info').textContent = `Total Reps Completed: ${finalCompleted}`;
            const totalMissedRepsInfo = document.getElementById('total-missed-reps-info');
            if (totalFinalMissed > 0) {
                totalMissedRepsInfo.textContent = `Total Reps Missed: ${totalFinalMissed}`;
                totalMissedRepsInfo.classList.remove('hidden');
            } else {
                totalMissedRepsInfo.classList.add('hidden');
            }
            const beastModeInfo = document.getElementById('beast-mode-info');
            if (beastModeReps > 0) {
                beastModeInfo.textContent = `Beast Mode: ${beastModeReps} extra reps!`;
                beastModeInfo.classList.remove('hidden');
            } else {
                beastModeInfo.classList.add('hidden');
            }
            restartBtn.classList.remove('hidden');
            if (totalFinalMissed > 0) retryBtn.classList.remove('hidden');
            else retryBtn.classList.add('hidden');
            downloadCsvBtn.classList.remove('hidden');
            displayRoundSummary();
            workoutScreen.classList.add('hidden');
            completeScreen.classList.remove('hidden');
            saveWorkoutData('completed');
        }

        function resetApp() {
            clearInterval(totalTimerInterval);
            document.title = 'Rep Down';
            if (previousAttemptCompleted > 0) {
                retryInfoDisplay.textContent = `${previousAttemptCompleted} reps from your last attempt will be added.`;
                retryInfoDisplay.classList.remove('hidden');
            } else {
                retryInfoDisplay.classList.add('hidden');
            }
            downloadCsvBtn.classList.add('hidden');
            updateChallengeInfo();
            completeScreen.classList.add('hidden');
            workoutScreen.classList.add('hidden');
            setupScreen.classList.remove('hidden');
            repsError.classList.add('hidden');
            exerciseError.classList.add('hidden');
            doneBtn.textContent = 'Start Next Round';

            customExercisesAdded = 0;
            document.querySelectorAll('.custom-exercise-item').forEach(el => el.remove());
            addExerciseBtn.classList.remove('hidden');
            addExerciseLimitMsg.classList.add('hidden');
            newExerciseForm.classList.add('hidden');
            newExerciseInput.value = '';
        }

        function updateRepDisplay() {
            currentRpsDisplay.textContent = currentReps;
        }

        function updateDoneButtonText() {
            doneBtn.textContent = currentReps === 1 ? "I'm Done!" : "Start Next Round";
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const formattedSeconds = remainingSeconds < 10 ? '0' + remainingSeconds : remainingSeconds;
            return `${minutes}:${formattedSeconds}`;
        }

        function startTotalTimer() {
            clearInterval(totalTimerInterval);
            roundStartTime = Date.now();
            let timeLeft = 600; // 10 minutes
            let isOvertime = false;
            totalTimerDisplay.textContent = formatTime(timeLeft);
            document.title = `${formatTime(timeLeft)} - Rep Down`;
            const container = document.getElementById('total-timer-container');
            const timerLabel = container.querySelector('p:first-child');
            timerLabel.textContent = "Time Remaining for this Round";
            timerLabel.classList.remove('text-red-500');
            totalTimerDisplay.classList.remove('text-red-500');
            totalTimerInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft >= 0) {
                    const formattedTime = formatTime(timeLeft);
                    totalTimerDisplay.textContent = formattedTime;
                    document.title = `${formattedTime} - Rep Down`;
                } else {
                    if (!isOvertime) {
                        isOvertime = true;
                        timerLabel.textContent = "Finish Your Reps!";
                        timerLabel.classList.add('text-red-500');
                        totalTimerDisplay.classList.add('text-red-500');
                    }
                    const overtime = Math.abs(timeLeft);
                    const formattedOvertime = `+${formatTime(overtime)}`;
                    totalTimerDisplay.textContent = formattedOvertime;
                    document.title = `${formattedOvertime} - Rep Down`;
                }
            }, 1000);
        }

        function handleAddNewExercise() {
            const exerciseName = newExerciseInput.value.trim();
            if (exerciseName === '') {
                alert("Please enter an exercise name.");
                return;
            }

            const allCheckboxes = document.querySelectorAll('#exercise-selection input[type="checkbox"]');
            const isDuplicate = Array.from(allCheckboxes).some(cb => cb.value.toLowerCase() === exerciseName.toLowerCase());
            if (isDuplicate) {
                alert("This exercise already exists.");
                return;
            }

            const newId = `custom-${exerciseName.replace(/\s+/g, '-').toLowerCase()}`;
            
            const newExerciseEl = document.createElement('div');
            newExerciseEl.className = 'flex items-center custom-exercise-item';
            
            newExerciseEl.innerHTML = `
                <input id="${newId}" type="checkbox" checked value="${exerciseName}" class="w-4 h-4 text-gold-500 bg-gray-700 border-gray-600 rounded focus:ring-gold-500 focus:ring-2">
                <label for="${newId}" class="ml-2 text-base font-medium text-gray-300">${exerciseName}</label>
            `;
            exerciseSelection.appendChild(newExerciseEl);

            customExercisesAdded++;
            newExerciseInput.value = '';
            newExerciseForm.classList.add('hidden');

            if (customExercisesAdded >= 2) {
                addExerciseBtn.classList.add('hidden');
                addExerciseLimitMsg.classList.remove('hidden');
            } else {
                addExerciseBtn.classList.remove('hidden');
            }
        }

        // --- Initialize App ---
        document.addEventListener('DOMContentLoaded', () => {
            updateChallengeInfo();
            initFirebase();
            
            signOutBtn.addEventListener('click', () => {
                signOut(auth).catch(error => console.error("Sign out error", error));
            });
            
            repsInput.addEventListener('change', () => {
                if (parseInt(repsInput.value) < 1) repsInput.value = 1;
                if (parseInt(repsInput.value) > 100) repsInput.value = 100;
            });
            startBtn.addEventListener('click', startWorkout);
            doneBtn.addEventListener('click', completeRound);
            endBtn.addEventListener('click', endWorkout);
            restartBtn.addEventListener('click', () => {
                previousAttemptCompleted = 0;
                previousAttemptMissedByExercise = {};
                roundTimes = [];
                resetApp();
            });
            retryBtn.addEventListener('click', retryWorkout);
            downloadCsvBtn.addEventListener('click', downloadCSV);

            addExerciseBtn.addEventListener('click', () => {
                addExerciseBtn.classList.add('hidden');
                newExerciseForm.classList.remove('hidden');
                newExerciseInput.focus();
            });
            saveExerciseBtn.addEventListener('click', handleAddNewExercise);
        });

    </script>
</body>
</html>

